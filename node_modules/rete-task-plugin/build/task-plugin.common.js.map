{"version":3,"file":"task-plugin.common.js","sources":["../src/task.js","../src/index.js"],"sourcesContent":["export class Task {\n\n    constructor(inputs, component, worker) {\n        this.inputs = inputs;\n        this.component = component;\n        this.worker = worker;\n        this.next = [];\n        this.outputData = null;\n        this.closed = [];\n\n        this.getInputs('option').forEach(key => {\n            this.inputs[key].forEach(con => {\n                con.task.next.push({ key: con.key, task: this });\n            })\n        });\n    }\n\n    getInputs(type) {\n        return Object.keys(this.inputs)\n            .filter(key => this.inputs[key][0])\n            .filter(key => this.inputs[key][0].type === type)\n    }\n\n    reset() {\n        this.outputData = null;\n    }\n\n    async run(data, needReset = true, garbage = [], propagate = true) {\n        if (needReset)\n            garbage.push(this);\n        \n        if (!this.outputData) {\n            var inputs = {};\n\n            await Promise.all(this.getInputs('output').map(async key => {\n                inputs[key] = await Promise.all(this.inputs[key].map(async con => {\n                    if (con) {\n                        await con.task.run(data, false, garbage, false);\n                        return con.task.outputData[con.key];\n                    }\n                }));\n            }));\n\n            this.outputData = await this.worker(this, inputs, data);\n\n            if (propagate)\n                await Promise.all(\n                    this.next\n                        .filter(f => !this.closed.includes(f.key))\n                        .map(async f => \n                            await f.task.run(data, false, garbage)\n                        )\n                );\n        }\n        \n        if (needReset)\n            garbage.map(t => t.reset());\n    }\n  \n    clone(root = true, oldTask, newTask) {\n        const inputs = Object.assign({}, this.inputs);\n\n        if (root) // prevent of adding this task to `next` property of predecessor\n            this.getInputs('option').map(key => delete inputs[key]);\n        else // replace old tasks with new copies\n            Object.keys(inputs).map(key => {\n                inputs[key] = inputs[key].map(con => ({\n                    ...con,\n                    task: con.task === oldTask ? newTask : con.task\n                }));\n            });\n    \n        const task = new Task(inputs, this.component, this.worker);\n\n        // manually add a copies of follow tasks\n        task.next = this.next.map(n => ({ key: n.key, task: n.task.clone(false, this, task)}));\n    \n        return task;\n    }\n}","import { Task } from './task';\n\nfunction install(editor) {\n        \n    editor.on('componentregister', component => {\n        if (!component.task)\n            throw 'Task plugin requires a task property in component';\n        if (component.task.outputs.constructor !== Object)\n            throw 'The \"outputs\" field must be an object whose keys correspond to the Output\\'s keys';\n        \n        const taskWorker = component.worker;\n        const taskOptions = component.task;\n\n        component.worker = (node, inputs, outputs) => {\n            const task = new Task(inputs, component, (ctx, inps, data) => {\n                return taskWorker.call(ctx, node, inps, data);\n            });\n\n            if (taskOptions.init) taskOptions.init(task, node);\n            \n            Object.keys(taskOptions.outputs).map(key => {\n                outputs[key] = { type: taskOptions.outputs[key], key, task }\n            });\n        }\n\n    });\n}\n\nexport { Task } from './task';\nexport default {\n    name: 'task-plugin',\n    install\n}"],"names":["Task","inputs","component","worker","next","outputData","closed","getInputs","forEach","key","con","task","push","type","Object","keys","filter","data","needReset","garbage","propagate","Promise","all","map","run","f","includes","t","reset","root","oldTask","newTask","assign","n","clone","install","editor","on","outputs","constructor","taskWorker","taskOptions","node","ctx","inps","call","init","name"],"mappings":"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"}